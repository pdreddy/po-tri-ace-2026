<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TriAce 2026 ‚Äì Score Entry</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .score-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem;
        }
        
        /* Access Card */
        .access-box {
            background: #fff;
            border-radius: 16px;
            padding: 2.5rem 2rem;
            box-shadow: 0 10px 40px rgba(0,0,0,.15);
            text-align: center;
            margin-top: 3rem;
        }
        
        .access-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: .75rem;
            font-size: 1.75rem;
            font-weight: 900;
            color: #1a202c;
            margin-bottom: 2rem;
        }
        
        .access-form {
            display: flex;
            gap: 1rem;
            justify-content: center;
            align-items: center;
            margin: 2rem 0 1.5rem;
            flex-wrap: wrap;
        }
        
        .password-input {
            padding: .875rem 1.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            width: 100%;
            max-width: 320px;
            text-align: center;
            transition: all .2s;
        }
        
        .password-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }
        
        .unlock-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            border: none;
            padding: .875rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all .2s;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .unlock-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .access-hint {
            color: #64748b;
            font-size: .9rem;
            line-height: 1.6;
            margin-top: 1rem;
        }
        
        .access-hint strong {
            color: #475569;
        }
        
        /* Entry Section */
        .entry-section {
            margin-top: 2rem;
        }
        
        .entry-header {
            background: #fff;
            border-radius: 16px;
            padding: 1.5rem 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .entry-title {
            display: flex;
            align-items: center;
            gap: .75rem;
            flex: 1;
        }
        
        .entry-title h2 {
            font-size: 1.5rem;
            font-weight: 900;
            color: #1a202c;
            margin: 0;
        }
        
        .team-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
            padding: .35rem .75rem;
            border-radius: 8px;
            font-size: .85rem;
            font-weight: 700;
        }
        
        .lock-btn {
            background: #64748b;
            color: #fff;
            border: none;
            padding: .75rem 1.5rem;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all .2s;
        }
        
        .lock-btn:hover {
            background: #475569;
        }
        
        /* Undo Card */
        .undo-card {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #f59e0b;
            border-radius: 16px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.2);
        }
        
        .undo-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }
        
        .undo-text {
            flex: 1;
        }
        
        .undo-label {
            font-weight: 900;
            color: #92400e;
            font-size: .95rem;
            margin-bottom: .25rem;
        }
        
        .undo-info {
            color: #78350f;
            font-size: .875rem;
            font-weight: 600;
        }
        
        .undo-btn {
            background: #fff;
            color: #92400e;
            border: 2px solid #f59e0b;
            padding: .75rem 1.5rem;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            white-space: nowrap;
            transition: all .2s;
        }
        
        .undo-btn:hover {
            background: #f59e0b;
            color: #fff;
        }
        
        /* Form Card */
        .form-card {
            background: #fff;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,.1);
        }
        
        .score-textarea {
            width: 100%;
            min-height: 220px;
            padding: 1.25rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: .95rem;
            line-height: 1.6;
            resize: vertical;
            transition: all .2s;
        }
        
        .score-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }
        
        .section-box {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: .5rem;
            font-size: 1.1rem;
            font-weight: 900;
            color: #1a202c;
            margin-bottom: 1rem;
        }
        
        .preview-content {
            color: #64748b;
            font-style: italic;
            text-align: center;
            padding: 2rem 1rem;
        }
        
        .format-guide {
            background: linear-gradient(135deg, #e0f2fe, #dbeafe);
            border-left: 4px solid #3b82f6;
        }
        
        .format-guide pre {
            background: #fff;
            padding: 1rem;
            border-radius: 8px;
            font-size: .85rem;
            line-height: 1.7;
            overflow-x: auto;
            color: #1a202c;
            margin: 0;
        }
        
        .action-btns {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .btn-save {
            flex: 1;
            background: linear-gradient(135deg, #10b981, #059669);
            color: #fff;
            border: none;
            padding: 1rem 2rem;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all .2s;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }
        
        .btn-save:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        .btn-clear {
            background: #e2e8f0;
            color: #475569;
            border: none;
            padding: 1rem 1.5rem;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all .2s;
        }
        
        .btn-clear:hover {
            background: #cbd5e1;
        }
        
        .error-box {
            background: #fee2e2;
            border-left: 4px solid #ef4444;
            color: #991b1b;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: .75rem;
        }
        
        .match-item {
            background: #fff;
            padding: .875rem;
            margin: .5rem 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            font-size: .9rem;
        }
        
        .winner-tag {
            display: inline-block;
            background: #10b981;
            color: #fff;
            padding: .25rem .6rem;
            border-radius: 6px;
            font-size: .75rem;
            font-weight: 700;
            margin-left: .5rem;
        }
        
        /* Mobile */
        @media (max-width: 640px) {
            .access-box {
                padding: 2rem 1.5rem;
                margin-top: 2rem;
            }
            
            .access-title {
                font-size: 1.4rem;
            }
            
            .access-form {
                flex-direction: column;
                width: 100%;
            }
            
            .password-input {
                max-width: 100%;
            }
            
            .unlock-btn {
                width: 100%;
            }
            
            .entry-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .entry-title h2 {
                font-size: 1.25rem;
            }
            
            .lock-btn {
                width: 100%;
            }
            
            .undo-content {
                flex-direction: column;
                text-align: center;
            }
            
            .undo-btn {
                width: 100%;
            }
            
            .form-card {
                padding: 1.5rem;
            }
            
            .score-textarea {
                font-size: .875rem;
                min-height: 200px;
            }
            
            .action-btns {
                flex-direction: column;
            }
            
            .btn-save, .btn-clear {
                width: 100%;
            }
            
            .format-guide pre {
                font-size: .8rem;
            }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<header class="header">
    <div class="header-bar">
        <div class="brand">
            <img src="triace-logo.png" alt="TriAce Tennis" style="height:120px;">
            <div>
                <strong>TRIACE 2026</strong>
                <div class="tagline">18 Teams ¬∑ 2 Groups ¬∑ Infinite Drama</div>
            </div>
        </div>
        <button id="menuBtn" class="menu-btn">‚ò∞</button>
    </div>

    <nav id="siteNav" class="nav">
        <a href="index.html">üè† Home</a>
        <a href="rules.html">üìã Rules</a>
        <a href="schedule.html">üìÖ Schedule A</a>
        <a href="schedule-b.html">üìÖ Schedule B</a>
        <a href="standings.html">üìä Standings</a>
        <a href="scoring.html" aria-current="page">üìù Score Entry</a>
        <a href="history.html">üìú History</a>
        <a href="teams.html">üë• Teams</a>
    </nav>
</header>

<main class="score-container">

    <!-- DEFAULT: Password Entry -->
    <div id="accessSection">
        <div class="access-box">
            <div class="access-title">
                <span>üîí</span>
                <span>Score Entry Access</span>
            </div>
            
            <div class="access-form">
                <input type="password" id="passwordInput" class="password-input" placeholder="Enter team password" />
                <button class="unlock-btn" id="unlockBtn">Unlock Scoring</button>
            </div>
            
            <div class="access-hint">
                <strong>Team captains:</strong> enter your team's unique password.
            </div>
        </div>
    </div>

    <!-- UNLOCKED: Score Entry Form -->
    <div id="entrySection" class="hidden entry-section">
        
        <!-- Header -->
        <div class="entry-header">
            <div class="entry-title">
                <span style="font-size:1.75rem;">üìù</span>
                <div>
                    <h2>Quick Score Entry</h2>
                    <span class="team-badge" id="teamBadge"></span>
                </div>
            </div>
            <button class="lock-btn" id="lockBtn">üîí Lock</button>
        </div>

        <!-- Admin-Only Delete Last Result -->
        <div id="deleteCard" class="undo-card" style="display:none;">
            <div class="undo-content">
                <div class="undo-text">
                    <div class="undo-label">üóëÔ∏è Delete Last Submitted Match (Admin Only)</div>
                    <div class="undo-info" id="deleteInfo"></div>
                </div>
                <button class="undo-btn" onclick="deleteLast()">üóëÔ∏è Delete Last Result</button>
            </div>
        </div>

        <!-- Form -->
        <div class="form-card">
            <textarea id="scoreText" class="score-textarea" placeholder="Paste match results here...

Example:
A1 vs A2
S1: A1_P1 vs A2_P1 1-0(8-5) (won) A1
S2: A1_P2 vs A2_P2 0-1(5-8) (won) A2
D1: A1_P1/A1_P2 vs A2_P1/A2_P2 4-3, 1-4, 0-4 (won) A2"></textarea>

            <!-- Preview -->
            <div class="section-box">
                <div class="section-title">
                    <span>üìã</span>
                    <span>Preview</span>
                </div>
                <div id="preview" class="preview-content">Enter scores above to see preview</div>
            </div>

            <!-- Format Guide -->
            <div class="section-box format-guide">
                <div class="section-title" style="color:#1e40af;">
                    <span>üìñ</span>
                    <span>Format Guide</span>
                </div>
                <pre>Teams: TEAM1 vs TEAM2 (A1 vs A2)

Singles (S1, S2):
S1: A1_Player vs A2_Player 1-0(8-5) (won) A1
  ‚Ä¢ 1-0 or 0-1 (winner gets 1 set)
  ‚Ä¢ Game score in parentheses

Doubles (D1):
D1: P1/P2 vs P3/P4 4-3, 1-4, 0-4 (won) A2
  ‚Ä¢ 3 sets with games
  ‚Ä¢ Winner from most sets won</pre>
            </div>

            <!-- Actions -->
            <div class="action-btns">
                <button class="btn-save" id="saveBtn">üíæ Save Match</button>
                <button class="btn-clear" id="clearBtn">üóëÔ∏è Clear</button>
            </div>
        </div>

    </div>

</main>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyDbO0eP52i4t3V94bEiDcl7WoKbSrrM9VA",
      authDomain: "koc2-20fb8.firebaseapp.com",
      databaseURL: "https://koc2-20fb8-default-rtdb.firebaseio.com",
      projectId: "koc2-20fb8",
      storageBucket: "koc2-20fb8.firebasestorage.app",
      messagingSenderId: "317734341461",
      appId: "1:317734341461:web:1bcad5a1792fac0e46bddc"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    
    let team = null;
    let admin = false;
    let lastKey = null;

    const PASSWORDS = {
        'A1#': 'A1', 'A2#': 'A2', 'A3#': 'A3', 'A4#': 'A4', 'A5#': 'A5',
        'A6#': 'A6', 'A7#': 'A7', 'A8#': 'A8', 'A9#': 'A9',
        'B1#': 'B1', 'B2#': 'B2', 'B3#': 'B3', 'B4#': 'B4', 'B5#': 'B5',
        'B6#': 'B6', 'B7#': 'B7', 'B8#': 'B8', 'B9#': 'B9',
        'ADMIN#2026': 'ADMIN'
    };

    const groupA = [
      { name: 'Team A1', abbreviation: 'A1', players: ['P1', 'P2', 'P3'] },
      { name: 'Team A2', abbreviation: 'A2', players: ['P1', 'P2', 'P3'] },
      { name: 'Team A3', abbreviation: 'A3', players: ['P1', 'P2', 'P3'] },
      { name: 'Team A4', abbreviation: 'A4', players: ['P1', 'P2', 'P3'] },
      { name: 'Team A5', abbreviation: 'A5', players: ['P1', 'P2', 'P3'] },
      { name: 'Team A6', abbreviation: 'A6', players: ['P1', 'P2', 'P3'] },
      { name: 'Team A7', abbreviation: 'A7', players: ['P1', 'P2', 'P3'] },
      { name: 'Team A8', abbreviation: 'A8', players: ['P1', 'P2', 'P3'] },
      { name: 'Team A9', abbreviation: 'A9', players: ['P1', 'P2', 'P3'] }
    ];

    const groupB = [
      { name: 'Team B1', abbreviation: 'B1', players: ['Manish', 'Biju', 'Ritesh'] },
      { name: 'Team B2', abbreviation: 'B2', players: ['P1', 'P2', 'P3'] },
      { name: 'Team B3', abbreviation: 'B3', players: ['Kails', 'Raja M', 'Vivek Reddy'] },
      { name: 'Team B4', abbreviation: 'B4', players: ['P1', 'P2', 'P3'] },
      { name: 'Team B5', abbreviation: 'B5', players: ['P1', 'P2', 'P3'] },
      { name: 'Team B6', abbreviation: 'B6', players: ['P1', 'P2', 'P3'] },
      { name: 'Team B7', abbreviation: 'B7', players: ['P1', 'P2', 'P3'] },
      { name: 'Team B8', abbreviation: 'B8', players: ['P1', 'P2', 'P3'] },
      { name: 'Team B9', abbreviation: 'B9', players: ['P1', 'P2', 'P3'] }
    ];

    const TEAMS = new Map([...groupA, ...groupB].map(t => [t.abbreviation.toUpperCase(), t]));

    auth.signInAnonymously();

    document.getElementById('unlockBtn').addEventListener('click', () => {
        const pwd = document.getElementById('passwordInput').value.trim().toUpperCase();
        const t = PASSWORDS[pwd];
        
        if (t) {
            team = t === 'ADMIN' ? null : t;
            admin = t === 'ADMIN';
            
            document.getElementById('accessSection').classList.add('hidden');
            document.getElementById('entrySection').classList.remove('hidden');
            document.getElementById('teamBadge').textContent = admin ? 'ADMIN' : t;
            
            loadLast();
        } else {
            alert('‚ùå Invalid password');
        }
    });

    document.getElementById('lockBtn').addEventListener('click', () => {
        team = null;
        admin = false;
        document.getElementById('accessSection').classList.remove('hidden');
        document.getElementById('entrySection').classList.add('hidden');
        document.getElementById('passwordInput').value = '';
        document.getElementById('scoreText').value = '';
        document.getElementById('deleteCard').style.display = 'none';
        updatePreview();
    });

    function parse(txt) {
        const res = [], errs = [];
        const lines = txt.trim().split('\n').map(l => l.trim()).filter(Boolean);
        
        if (!lines.length) return { res: [], errs: ['Empty'], t1: null, t2: null };
        
        const tm = lines[0].match(/^(\w+)\s+vs\.?\s+(\w+)$/i);
        if (!tm) {
            errs.push('First line: TEAM1 vs TEAM2');
            return { res: [], errs, t1: null, t2: null };
        }
        
        const t1 = TEAMS.get(tm[1].toUpperCase());
        const t2 = TEAMS.get(tm[2].toUpperCase());
        
        if (!t1) errs.push(`Unknown: ${tm[1]}`);
        if (!t2) errs.push(`Unknown: ${tm[2]}`);
        if (errs.length) return { res: [], errs, t1: null, t2: null };
        
        for (let i = 1; i < lines.length; i++) {
            try {
                const p = parseLine(lines[i], t1, t2);
                if (p) res.push(p);
            } catch (e) {
                errs.push(`Line ${i + 1}: ${e.message}`);
            }
        }
        
        return { res, errs, t1, t2 };
    }

    function parseLine(line, t1, t2) {
        const typ = line.match(/^(S|D)(\d+):\s*/i);
        if (!typ) throw new Error('Start with S1:, S2:, or D1:');
        
        const mt = typ[1].toUpperCase();
        const num = typ[2];
        let rem = line.slice(typ[0].length).trim();
        
        const won = rem.match(/\(won\)\s*(\w+)\s*\.?\s*$/i);
        if (!won) throw new Error('Need (won) TEAM');
        
        const win = won[1].toUpperCase();
        rem = rem.slice(0, won.index).trim();
        
        let wn = null;
        if (win === t1.abbreviation.toUpperCase()) wn = 1;
        else if (win === t2.abbreviation.toUpperCase()) wn = 2;
        else throw new Error(`Winner: ${t1.abbreviation} or ${t2.abbreviation}`);
        
        const vs = rem.match(/\s+vs\.?\s+/i);
        if (!vs) throw new Error('Need "vs"');
        
        const left = rem.slice(0, vs.index).trim().split('/').map(p => p.trim()).filter(Boolean);
        const right = rem.slice(vs.index + vs[0].length).trim();
        
        const sc = right.match(/\s+(\d+-\d+)/);
        if (!sc) throw new Error('No scores');
        
        const rp = right.slice(0, sc.index).trim().split('/').map(p => p.trim()).filter(Boolean);
        const scores = right.slice(sc.index).trim();
        
        if (mt === 'S') {
            const sm = scores.match(/^(\d+)-(\d+)\((\d+)-(\d+)\)$/);
            if (!sm) throw new Error('Format: 1-0(8-5)');
            
            const s1 = +sm[1], s2 = +sm[2], g1 = +sm[3], g2 = +sm[4];
            if (s1 + s2 !== 1) throw new Error('Singles: 1-0 or 0-1');
            
            return {
                label: `S${num}`,
                type: 'singles',
                players: { team1: left, team2: rp },
                sets: [{ set: 1, team1: g1, team2: g2 }],
                g1, g2, sets1: s1, sets2: s2, winnerTeamNum: wn
            };
        } else {
            const sets = [];
            const sp = /(\d+)-(\d+)/g;
            let m;
            while ((m = sp.exec(scores))) {
                sets.push({ team1: +m[1], team2: +m[2] });
            }
            if (sets.length !== 3) throw new Error('Doubles: 3 sets');
            
            let g1 = 0, g2 = 0, s1 = 0, s2 = 0;
            const sd = [];
            for (let i = 0; i < 3; i++) {
                const s = sets[i];
                g1 += s.team1;
                g2 += s.team2;
                if (s.team1 > s.team2) s1++;
                else if (s.team2 > s.team1) s2++;
                sd.push({ set: i + 1, team1: s.team1, team2: s.team2 });
            }
            
            return {
                label: `D${num}`,
                type: 'doubles',
                players: { team1: left, team2: rp },
                sets: sd,
                g1, g2, sets1: s1, sets2: s2, winnerTeamNum: wn
            };
        }
    }

    const scoreText = document.getElementById('scoreText');
    const preview = document.getElementById('preview');
    
    scoreText.addEventListener('input', updatePreview);
    
    function updatePreview() {
        const txt = scoreText.value;
        if (!txt.trim()) {
            preview.innerHTML = '<div class="preview-content">Enter scores above to see preview</div>';
            return;
        }
        
        const { res, errs, t1, t2 } = parse(txt);
        let h = '';
        
        if (t1 && t2) {
            h += `<div style="font-weight:900;font-size:1.05rem;color:#1a202c;margin-bottom:.75rem;padding-bottom:.5rem;border-bottom:2px solid #e2e8f0;">${t1.abbreviation} vs ${t2.abbreviation}</div>`;
        }
        
        if (errs.length) {
            h += '<div class="error-box"><strong>‚ö†Ô∏è Errors:</strong><ul style="margin:.5rem 0 0 1.25rem;">';
            errs.forEach(e => h += `<li style="margin:.25rem 0;">${e}</li>`);
            h += '</ul></div>';
        }
        
        res.forEach(r => {
            const w = r.winnerTeamNum === 1 ? t1.abbreviation : t2.abbreviation;
            const ss = r.sets.map(s => `${s.team1}-${s.team2}`).join(', ');
            
            h += `<div class="match-item">
                <strong>${r.label}:</strong> ${r.players.team1.join('/')} vs ${r.players.team2.join('/')}<br>
                <span style="margin-left:1.5rem;color:#64748b;">Score: ${ss}</span>
                <span class="winner-tag">Won: ${w}</span>
            </div>`;
        });
        
        if (!res.length && !errs.length) {
            h = '<div class="preview-content">No matches parsed</div>';
        }
        
        preview.innerHTML = h;
    }

    document.getElementById('saveBtn').addEventListener('click', () => {
        const { res, errs, t1, t2 } = parse(scoreText.value);
        
        if (errs.length) {
            alert('‚ùå Errors:\n\n' + errs.join('\n'));
            return;
        }
        
        if (!res.length) {
            alert('‚ùå No matches');
            return;
        }
        
        if (!admin && team !== t1.abbreviation && team !== t2.abbreviation) {
            alert(`‚ùå Only for your team (${team})`);
            return;
        }
        
        let s1 = 0, s2 = 0, g1 = 0, g2 = 0, courtsWon1 = 0, courtsWon2 = 0;
        res.forEach(r => {
            s1 += r.sets1;
            s2 += r.sets2;
            g1 += r.g1;
            g2 += r.g2;
            if (r.winnerTeamNum === 1) courtsWon1++;
            else courtsWon2++;
        });

        // Determine overall match winner for display purposes (team that wins 2 out of 3 matches)
        const winner = courtsWon1 > courtsWon2 ? t1.name : (courtsWon2 > courtsWon1 ? t2.name : null);
        if (!winner) {
            alert('‚ùå Match is tied. Winner must win 2 out of 3 matches.');
            return;
        }

        // Format data to match what standings.html and history.html expect
        // Points are awarded per individual match (1 point per S1/S2/D1 won), not overall match
        const data = {
            t1: t1.name,  // Full team name (e.g., 'Team A1')
            t2: t2.name,  // Full team name
            win: winner,  // Overall match winner (for display/history purposes)
            s1: s1,  // Sets won by team 1
            s2: s2,  // Sets won by team 2
            g1: g1,  // Total games won by team 1
            g2: g2,  // Total games won by team 2
            ts: firebase.database.ServerValue.TIMESTAMP,
            lines: res,  // Match details with individual winners (used for point calculation)
            submittedBy: admin ? 'Admin' : team
        };

        const ref = db.ref('TriAceDBNEW').push();
        ref.set(data).then(() => {
            lastKey = ref.key;
            localStorage.setItem('lastKey', lastKey);
            localStorage.setItem('lastData', JSON.stringify(data));

            alert('‚úÖ Match saved!');
            scoreText.value = '';
            updatePreview();

            // Only show delete option for admins
            if (admin) {
                document.getElementById('deleteCard').style.display = 'block';
                document.getElementById('deleteInfo').textContent =
                    `${data.t1} vs ${data.t2} - Winner: ${data.win} (${data.s1}-${data.s2})`;
            }
        }).catch(e => {
            alert('‚ùå Failed: ' + e.message);
        });
    });

    function loadLast() {
        lastKey = localStorage.getItem('lastKey');
        const last = localStorage.getItem('lastData');

        // Only show delete option for admins
        if (admin && lastKey && last) {
            const d = JSON.parse(last);
            document.getElementById('deleteCard').style.display = 'block';
            document.getElementById('deleteInfo').textContent =
                `${d.t1} vs ${d.t2} - Winner: ${d.win} (${d.s1}-${d.s2})`;
        }
    }

    function deleteLast() {
        // Admin-only protection
        if (!admin) {
            alert('‚ùå Only admins can delete matches');
            return;
        }

        if (!lastKey) {
            alert('‚ùå No match to delete');
            return;
        }

        if (!confirm('‚ö†Ô∏è Delete last match? This action cannot be undone.')) return;

        db.ref('TriAceDBNEW/' + lastKey).remove().then(() => {
            alert('‚úÖ Match deleted successfully');
            localStorage.removeItem('lastKey');
            localStorage.removeItem('lastData');
            lastKey = null;
            document.getElementById('deleteCard').style.display = 'none';
        }).catch(e => {
            alert('‚ùå Failed to delete: ' + e.message);
        });
    }

    document.getElementById('clearBtn').addEventListener('click', () => {
        scoreText.value = '';
        updatePreview();
    });

    document.getElementById('menuBtn').addEventListener('click', () => {
        document.getElementById('siteNav').classList.toggle('open');
    });
</script>

</body>
</html>
