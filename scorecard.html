<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TriAce 2026 ‚Äì Score Entry</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body {
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .score-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Access Card */
        .access-box {
            background: #fff;
            border-radius: 8px;
            padding: 2rem 1.5rem;
            border: 1px solid #e2e8f0;
            text-align: center;
            margin-top: 2rem;
        }

        .access-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: .5rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 1.5rem;
        }

        .access-form {
            display: flex;
            gap: .75rem;
            justify-content: center;
            align-items: center;
            margin: 1.5rem 0 1rem;
            flex-wrap: wrap;
        }

        .password-input {
            padding: .75rem 1rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 1rem;
            width: 100%;
            max-width: 280px;
            text-align: center;
        }

        .password-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .unlock-btn {
            background: #667eea;
            color: #fff;
            border: none;
            padding: .75rem 1.5rem;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .unlock-btn:hover {
            background: #5568d3;
        }

        .access-hint {
            color: #64748b;
            font-size: .875rem;
            line-height: 1.5;
            margin-top: .75rem;
        }

        .access-hint strong {
            color: #475569;
        }

        /* Entry Section */
        .entry-section {
            margin-top: 1.5rem;
        }

        .entry-header {
            background: #fff;
            border-radius: 8px;
            padding: 1.25rem 1.5rem;
            border: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .entry-title {
            display: flex;
            align-items: center;
            gap: .5rem;
            flex: 1;
        }

        .entry-title h2 {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1a202c;
            margin: 0;
        }

        .team-badge {
            background: #667eea;
            color: #fff;
            padding: .25rem .5rem;
            border-radius: 4px;
            font-size: .8rem;
            font-weight: 600;
        }

        .lock-btn {
            background: #64748b;
            color: #fff;
            border: none;
            padding: .5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            font-size: .9rem;
        }

        .lock-btn:hover {
            background: #475569;
        }

        /* Undo Card */
        .undo-card {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 8px;
            padding: 1rem 1.25rem;
            margin-bottom: 1rem;
        }

        .undo-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .undo-text {
            flex: 1;
            min-width: 200px;
        }

        .undo-label {
            font-weight: 700;
            color: #92400e;
            font-size: .875rem;
            margin-bottom: .25rem;
        }

        .undo-info {
            color: #78350f;
            font-size: .8rem;
            font-weight: 500;
        }

        .undo-btn {
            background: #fff;
            color: #92400e;
            border: 1px solid #f59e0b;
            padding: .5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            font-size: .875rem;
        }

        .undo-btn:hover {
            background: #f59e0b;
            color: #fff;
        }

        /* Form Card */
        .form-card {
            background: #fff;
            border-radius: 8px;
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
        }

        .score-textarea {
            width: 100%;
            min-height: 250px;
            padding: 1rem;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: .95rem;
            line-height: 1.6;
            resize: vertical;
            background: #fff;
        }

        .score-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .section-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1.25rem;
            margin: 1.25rem 0;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: .5rem;
            font-size: 1rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: .75rem;
        }

        .preview-content {
            color: #64748b;
            font-style: italic;
            text-align: center;
            padding: 1rem;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }


        .action-btns {
            display: flex;
            gap: .75rem;
            margin-top: 1.25rem;
        }

        .btn-save {
            flex: 1;
            background: #10b981;
            color: #fff;
            border: none;
            padding: .875rem 1.5rem;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-save:hover {
            background: #059669;
        }

        .btn-clear {
            background: #e2e8f0;
            color: #475569;
            border: none;
            padding: .875rem 1.25rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-clear:hover {
            background: #cbd5e1;
        }

        .error-box {
            background: #fee2e2;
            border-left: 3px solid #ef4444;
            color: #991b1b;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .match-item {
            background: #fff;
            padding: .875rem 1rem;
            margin: .5rem 0;
            border-radius: 6px;
            border-left: 3px solid #667eea;
            font-size: .9rem;
        }

        .winner-tag {
            display: inline-block;
            background: #10b981;
            color: #fff;
            padding: .2rem .5rem;
            border-radius: 4px;
            font-size: .7rem;
            font-weight: 600;
            margin-left: .5rem;
        }

        /* Mobile */
        @media (max-width: 768px) {
            .score-container {
                padding: .75rem;
            }

            .access-box {
                padding: 1.5rem 1rem;
                margin-top: 1rem;
            }

            .access-title {
                font-size: 1.25rem;
                margin-bottom: 1rem;
            }

            .access-form {
                flex-direction: column;
                width: 100%;
                gap: .5rem;
            }

            .password-input {
                max-width: 100%;
                padding: .75rem;
            }

            .unlock-btn {
                width: 100%;
                padding: .75rem;
            }

            .entry-header {
                flex-direction: column;
                gap: .75rem;
                align-items: flex-start;
                padding: 1rem;
            }

            .entry-title h2 {
                font-size: 1.1rem;
            }

            .lock-btn {
                width: 100%;
            }

            .undo-content {
                flex-direction: column;
                text-align: left;
                gap: .75rem;
            }

            .undo-text {
                min-width: auto;
            }

            .undo-btn {
                width: 100%;
            }

            .form-card {
                padding: 1rem;
            }

            .score-textarea {
                font-size: .875rem;
                min-height: 200px;
                padding: .875rem;
                line-height: 1.5;
            }

            .section-box {
                padding: 1rem;
                margin: 1rem 0;
            }

            .section-title {
                font-size: .95rem;
            }

            .action-btns {
                flex-direction: column;
                gap: .5rem;
            }

            .btn-save, .btn-clear {
                width: 100%;
                padding: .875rem;
            }

            .match-item {
                padding: .75rem;
                font-size: .85rem;
            }

            .preview-content {
                padding: .75rem;
                font-size: .85rem;
            }
        }

        @media (max-width: 480px) {
            .access-title {
                font-size: 1.1rem;
            }

            .entry-title h2 {
                font-size: 1rem;
            }

            .score-textarea {
                font-size: .8rem;
                min-height: 180px;
            }

            .section-box {
                padding: .875rem;
            }
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>

<header class="header">
    <div class="header-bar">
        <div class="brand">
            <img src="triace-logo.png" alt="TriAce Tennis" style="height:120px;">
            <div>
                <strong>TRIACE 2026</strong>
                <div class="tagline">18 Teams ¬∑ 2 Groups ¬∑ Infinite Drama</div>
            </div>
        </div>
        <button id="menuBtn" class="menu-btn">‚ò∞</button>
    </div>

    <nav id="siteNav" class="nav">
        <a href="index.html">üè† Home</a>
        <a href="rules.html">üìã Rules</a>
        <a href="schedule.html">üìÖ Schedule A</a>
        <a href="schedule-b.html">üìÖ Schedule B</a>
        <a href="standings.html">üìä Standings</a>
        <a href="scoring.html" aria-current="page">üìù Score Entry</a>
        <a href="history.html">üìú History</a>
        <a href="teams.html">üë• Teams</a>
    </nav>
</header>

<main class="score-container">

    <!-- DEFAULT: Password Entry -->
    <div id="accessSection">
        <div class="access-box">
            <div class="access-title">
                <span>üîí</span>
                <span>Score Entry Access</span>
            </div>

            <div class="access-form">
                <input type="password" id="passwordInput" class="password-input" placeholder="Enter team password" />
                <button class="unlock-btn" id="unlockBtn">Unlock Scoring</button>
            </div>

            <div class="access-hint">
                <strong>Team captains:</strong> enter your team's unique password.
            </div>
        </div>
    </div>

    <!-- UNLOCKED: Score Entry Form -->
    <div id="entrySection" class="hidden entry-section">

        <!-- Header -->
        <div class="entry-header">
            <div class="entry-title">
                <span style="font-size:1.75rem;">üìù</span>
                <div>
                    <h2>Quick Score Entry</h2>
                    <span class="team-badge" id="teamBadge"></span>
                </div>
            </div>
            <button class="lock-btn" id="lockBtn">üîí Lock</button>
        </div>

        <!-- Admin-Only Delete Last Result -->
        <div id="deleteCard" class="undo-card" style="display:none;">
            <div class="undo-content">
                <div class="undo-text">
                    <div class="undo-label">üóëÔ∏è Delete Last Submitted Match (Admin Only)</div>
                    <div class="undo-info" id="deleteInfo"></div>
                </div>
                <button class="undo-btn" onclick="deleteLast()">üóëÔ∏è Delete Last Result</button>
            </div>
        </div>

        <!-- Form -->
        <div class="form-card">
            <div style="margin-bottom: 1rem;">
                <label for="scoreText" style="display: block; font-weight: 700; color: #1a202c; margin-bottom: 0.5rem; font-size: 1rem;">
                    üìù Enter Match Results
                </label>
                <textarea id="scoreText" class="score-textarea" placeholder="B5 vs B1
S1: Ratnesh vs Manish 1-0(8-2) (won) B5
S2: Narayan vs Biju 1-0(8-1) (won) B5
D1: Ratnesh/Narayan vs Biju/Manish 3-4, 4-3, 4-0 (won) B1"></textarea>
            </div>

            <!-- Preview -->
            <div class="section-box" style="margin-top: 1.5rem;">
                <div class="section-title">
                    <span>üëÅÔ∏è</span>
                    <span>Live Preview</span>
                </div>
                <div id="preview" class="preview-content">Enter scores above to see preview</div>
            </div>

            <!-- Actions -->
            <div class="action-btns">
                <button class="btn-save" id="saveBtn">üíæ Save Match</button>
                <button class="btn-clear" id="clearBtn">üóëÔ∏è Clear</button>
            </div>
        </div>

    </div>

</main>

<script>
    const firebaseConfig = {
      apiKey: "AIzaSyDbO0eP52i4t3V94bEiDcl7WoKbSrrM9VA",
      authDomain: "koc2-20fb8.firebaseapp.com",
      databaseURL: "https://koc2-20fb8-default-rtdb.firebaseio.com",
      projectId: "koc2-20fb8",
      storageBucket: "koc2-20fb8.firebasestorage.app",
      messagingSenderId: "317734341461",
      appId: "1:317734341461:web:1bcad5a1792fac0e46bddc"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let team = null;
    let admin = false;
    let lastKey = null;

    const PASSWORDS = {
        'A1#': 'A1', 'A2#': 'A2', 'A3#': 'A3', 'A4#': 'A4', 'A5#': 'A5',
        'A6#': 'A6', 'A7#': 'A7', 'A8#': 'A8', 'A9#': 'A9',
        'B1#': 'B1', 'B2#': 'B2', 'B3#': 'B3', 'B4#': 'B4', 'B5#': 'B5',
        'B6#': 'B6', 'B7#': 'B7', 'B8#': 'B8', 'B9#': 'B9',
        'ADMIN#2026': 'ADMIN'
    };

    const groupA = [
      { name: 'Team A1', abbreviation: 'A1', players: ['P1', 'P2', 'P3'] },
      { name: 'Team A2', abbreviation: 'A2', players: ['P1', 'P2', 'P3'] },
      { name: 'Team A3', abbreviation: 'A3', players: ['P1', 'P2', 'P3'] },
      { name: 'Team A4', abbreviation: 'A4', players: ['P1', 'P2', 'P3'] },
      { name: 'Team A5', abbreviation: 'A5', players: ['P1', 'P2', 'P3'] },
      { name: 'Team A6', abbreviation: 'A6', players: ['P1', 'P2', 'P3'] },
      { name: 'Team A7', abbreviation: 'A7', players: ['P1', 'P2', 'P3'] },
      { name: 'Team A8', abbreviation: 'A8', players: ['P1', 'P2', 'P3'] },
      { name: 'Team A9', abbreviation: 'A9', players: ['P1', 'P2', 'P3'] }
    ];

    const groupB = [
      { name: 'Team B1', abbreviation: 'B1', players: ['Manish', 'Biju', 'Ritesh'] },
      { name: 'Team B2', abbreviation: 'B2', players: ['P1', 'P2', 'P3'] },
      { name: 'Team B3', abbreviation: 'B3', players: ['Kails', 'Raja M', 'Vivek Reddy'] },
      { name: 'Team B4', abbreviation: 'B4', players: ['P1', 'P2', 'P3'] },
      { name: 'Team B5', abbreviation: 'B5', players: ['P1', 'P2', 'P3'] },
      { name: 'Team B6', abbreviation: 'B6', players: ['P1', 'P2', 'P3'] },
      { name: 'Team B7', abbreviation: 'B7', players: ['P1', 'P2', 'P3'] },
      { name: 'Team B8', abbreviation: 'B8', players: ['P1', 'P2', 'P3'] },
      { name: 'Team B9', abbreviation: 'B9', players: ['P1', 'P2', 'P3'] }
    ];

    const TEAMS = new Map([...groupA, ...groupB].map(t => [t.abbreviation.toUpperCase(), t]));

    auth.signInAnonymously();

    document.getElementById('unlockBtn').addEventListener('click', () => {
        const pwd = document.getElementById('passwordInput').value.trim().toUpperCase();
        const t = PASSWORDS[pwd];

        if (t) {
            team = t === 'ADMIN' ? null : t;
            admin = t === 'ADMIN';

            document.getElementById('accessSection').classList.add('hidden');
            document.getElementById('entrySection').classList.remove('hidden');
            document.getElementById('teamBadge').textContent = admin ? 'ADMIN' : t;

            loadLast();
        } else {
            alert('‚ùå Invalid password');
        }
    });

    document.getElementById('lockBtn').addEventListener('click', () => {
        team = null;
        admin = false;
        document.getElementById('accessSection').classList.remove('hidden');
        document.getElementById('entrySection').classList.add('hidden');
        document.getElementById('passwordInput').value = '';
        document.getElementById('scoreText').value = '';
        document.getElementById('deleteCard').style.display = 'none';
        updatePreview();
    });

    function parse(txt) {
        const res = [], errs = [];
        const rawLines = txt.trim().split('\n').map(l => l.trim()).filter(Boolean);

        if (!rawLines.length) return { res: [], errs: ['Empty'], t1: null, t2: null };

        const tm = rawLines[0].match(/^(\w+)\s+vs\.?\s+(\w+)$/i);
        if (!tm) {
            errs.push('First line: TEAM1 vs TEAM2');
            return { res: [], errs, t1: null, t2: null };
        }

        const t1 = TEAMS.get(tm[1].toUpperCase());
        const t2 = TEAMS.get(tm[2].toUpperCase());

        if (!t1) errs.push(`Unknown: ${tm[1]}`);
        if (!t2) errs.push(`Unknown: ${tm[2]}`);
        if (errs.length) return { res: [], errs, t1: null, t2: null };

        // Merge lines where "(won) TEAM" is on the next line
        const mergedLines = [];
        for (let i = 1; i < rawLines.length; i++) {
            const currentLine = rawLines[i];
            const nextLine = i + 1 < rawLines.length ? rawLines[i + 1] : null;

            // Check if current line starts with S/D and next line is just "(won) TEAM"
            if (currentLine.match(/^(S|D)(\d+):/i) && nextLine && nextLine.match(/^\(won\)\s*(\w+)/i)) {
                mergedLines.push(currentLine + ' ' + nextLine);
                i++; // Skip the next line since we merged it
            } else {
                mergedLines.push(currentLine);
            }
        }

        for (let i = 0; i < mergedLines.length; i++) {
            try {
                const p = parseLine(mergedLines[i], t1, t2);
                if (p) res.push(p);
            } catch (e) {
                errs.push(`Line ${i + 2}: ${e.message}`); // +2 because line 1 is the team vs team line
            }
        }

        return { res, errs, t1, t2 };
    }

    function parseLine(line, t1, t2) {
        const typ = line.match(/^(S|D)(\d+):\s*/i);
        if (!typ) throw new Error('Start with S1:, S2:, or D1:');

        const mt = typ[1].toUpperCase();
        const num = typ[2];
        let rem = line.slice(typ[0].length).trim();

        // Look for "(won) TEAM" anywhere in the line (not just at the end)
        const won = rem.match(/\(won\)\s*(\w+)/i);
        if (!won) throw new Error('Need (won) TEAM');

        const win = won[1].toUpperCase();
        rem = rem.slice(0, won.index).trim();

        let wn = null;
        if (win === t1.abbreviation.toUpperCase()) wn = 1;
        else if (win === t2.abbreviation.toUpperCase()) wn = 2;
        else throw new Error(`Winner: ${t1.abbreviation} or ${t2.abbreviation}`);

        const vs = rem.match(/\s+vs\.?\s+/i);
        if (!vs) throw new Error('Need "vs"');

        const left = rem.slice(0, vs.index).trim().split('/').map(p => p.trim()).filter(Boolean);
        const right = rem.slice(vs.index + vs[0].length).trim();

        const sc = right.match(/\s+(\d+-\d+)/);
        if (!sc) throw new Error('No scores');

        const rp = right.slice(0, sc.index).trim().split('/').map(p => p.trim()).filter(Boolean);
        const scores = right.slice(sc.index).trim();

        if (mt === 'S') {
            const sm = scores.match(/^(\d+)-(\d+)\((\d+)-(\d+)\)$/);
            if (!sm) throw new Error('Format: 1-0(8-5)');

            const s1 = +sm[1], s2 = +sm[2], g1 = +sm[3], g2 = +sm[4];
            if (s1 + s2 !== 1) throw new Error('Singles: 1-0 or 0-1');

            return {
                label: `S${num}`,
                type: 'singles',
                players: { team1: left, team2: rp },
                sets: [{ set: 1, team1: g1, team2: g2 }],
                g1, g2, sets1: s1, sets2: s2, winnerTeamNum: wn
            };
        } else {
            const sets = [];
            const sp = /(\d+)-(\d+)/g;
            let m;
            while ((m = sp.exec(scores))) {
                sets.push({ team1: +m[1], team2: +m[2] });
            }
            if (sets.length !== 3) throw new Error('Doubles: 3 sets');

            let g1 = 0, g2 = 0, s1 = 0, s2 = 0;
            const sd = [];
            for (let i = 0; i < 3; i++) {
                const s = sets[i];
                g1 += s.team1;
                g2 += s.team2;
                if (s.team1 > s.team2) s1++;
                else if (s.team2 > s.team1) s2++;
                sd.push({ set: i + 1, team1: s.team1, team2: s.team2 });
            }

            return {
                label: `D${num}`,
                type: 'doubles',
                players: { team1: left, team2: rp },
                sets: sd,
                g1, g2, sets1: s1, sets2: s2, winnerTeamNum: wn
            };
        }
    }

    const scoreText = document.getElementById('scoreText');
    const preview = document.getElementById('preview');

    scoreText.addEventListener('input', updatePreview);

    function updatePreview() {
        const txt = scoreText.value;
        if (!txt.trim()) {
            preview.innerHTML = '<div class="preview-content">Enter scores above to see preview</div>';
            return;
        }

        const { res, errs, t1, t2 } = parse(txt);
        let h = '';

        if (t1 && t2) {
            h += `<div style="font-weight:700;font-size:1.1rem;color:#1a202c;margin-bottom:.75rem;padding-bottom:.5rem;border-bottom:1px solid #e2e8f0;">
                ${t1.abbreviation} vs ${t2.abbreviation}
            </div>`;
        }

        if (errs.length) {
            h += '<div class="error-box"><strong>‚ö†Ô∏è Errors:</strong><ul style="margin:.5rem 0 0 1.25rem;font-size:.875rem;">';
            errs.forEach(e => h += `<li style="margin:.25rem 0;">${e}</li>`);
            h += '</ul></div>';
        }

        if (res.length > 0 && t1 && t2) {
            // Calculate summary
            let s1 = 0, s2 = 0, g1 = 0, g2 = 0, courtsWon1 = 0, courtsWon2 = 0;

            res.forEach(r => {
                s1 += r.sets1;
                s2 += r.sets2;
                g1 += r.g1;
                g2 += r.g2;
                if (r.winnerTeamNum === 1) courtsWon1++;
                else courtsWon2++;
            });

            const winner = courtsWon1 > courtsWon2 ? t1.abbreviation : (courtsWon2 > courtsWon1 ? t2.abbreviation : 'TIE');

            h += `<div style="background:#e0f2fe;border-radius:6px;padding:.875rem;margin-bottom:.75rem;border-left:3px solid #3b82f6;font-size:.875rem;">
                <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:.5rem;">
                    <div><strong>Points:</strong> ${t1.abbreviation} ${courtsWon1} - ${courtsWon2} ${t2.abbreviation}</div>
                    <div><strong>Sets:</strong> ${s1}-${s2} | <strong>Games:</strong> ${g1}-${g2}</div>
                    <div style="grid-column:1/-1;margin-top:.5rem;padding-top:.5rem;border-top:1px solid #bae6fd;"><strong>Winner:</strong> <span style="color:#059669;font-weight:700;">${winner}</span></div>
                </div>
            </div>`;
        }

        res.forEach(r => {
            const w = r.winnerTeamNum === 1 ? t1.abbreviation : t2.abbreviation;
            const ss = r.sets.map(s => `${s.team1}-${s.team2}`).join(', ');
            const typeIcon = r.type === 'singles' ? 'üéæ' : 'üë•';

            h += `<div class="match-item">
                <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem;flex-wrap:wrap;">
                    <span>${typeIcon}</span>
                    <strong style="color:#667eea;">${r.label}</strong>
                    <span class="winner-tag">${w}</span>
                </div>
                <div style="color:#64748b;font-size:.85rem;">
                    ${r.players.team1.join('/')} vs ${r.players.team2.join('/')}<br>
                    <strong>${ss}</strong>
                </div>
            </div>`;
        });

        if (!res.length && !errs.length) {
            h = '<div class="preview-content">No matches parsed</div>';
        }

        preview.innerHTML = h;
    }

    document.getElementById('saveBtn').addEventListener('click', () => {
        const { res, errs, t1, t2 } = parse(scoreText.value);

        if (errs.length) {
            alert('‚ùå Errors:\n\n' + errs.join('\n'));
            return;
        }

        if (!res.length) {
            alert('‚ùå No matches');
            return;
        }

        if (!admin && team !== t1.abbreviation && team !== t2.abbreviation) {
            alert(`‚ùå Only for your team (${team})`);
            return;
        }

        let s1 = 0, s2 = 0, g1 = 0, g2 = 0, courtsWon1 = 0, courtsWon2 = 0;
        res.forEach(r => {
            s1 += r.sets1;
            s2 += r.sets2;
            g1 += r.g1;
            g2 += r.g2;
            if (r.winnerTeamNum === 1) courtsWon1++;
            else courtsWon2++;
        });

        // Determine overall match winner for display purposes (team that wins 2 out of 3 matches)
        const winner = courtsWon1 > courtsWon2 ? t1.name : (courtsWon2 > courtsWon1 ? t2.name : null);
        if (!winner) {
            alert('‚ùå Match is tied. Winner must win 2 out of 3 matches.');
            return;
        }

        // Format data to match what standings.html and history.html expect
        // Points are awarded per individual match (1 point per S1/S2/D1 won), not overall match
        const data = {
            t1: t1.name,  // Full team name (e.g., 'Team A1')
            t2: t2.name,  // Full team name
            win: winner,  // Overall match winner (for display/history purposes)
            s1: s1,  // Sets won by team 1
            s2: s2,  // Sets won by team 2
            g1: g1,  // Total games won by team 1
            g2: g2,  // Total games won by team 2
            ts: firebase.database.ServerValue.TIMESTAMP,
            lines: res,  // Match details with individual winners (used for point calculation)
            submittedBy: admin ? 'Admin' : team
        };

        const ref = db.ref('TriAceDBNEW').push();
        ref.set(data).then(() => {
            lastKey = ref.key;
            localStorage.setItem('lastKey', lastKey);
            localStorage.setItem('lastData', JSON.stringify(data));

            alert('‚úÖ Match saved!');
            scoreText.value = '';
            updatePreview();

            // Only show delete option for admins
            if (admin) {
                document.getElementById('deleteCard').style.display = 'block';
                document.getElementById('deleteInfo').textContent =
                    `${data.t1} vs ${data.t2} - Winner: ${data.win} (${data.s1}-${data.s2})`;
            }
        }).catch(e => {
            alert('‚ùå Failed: ' + e.message);
        });
    });

    function loadLast() {
        lastKey = localStorage.getItem('lastKey');
        const last = localStorage.getItem('lastData');

        // Only show delete option for admins
        if (admin && lastKey && last) {
            const d = JSON.parse(last);
            document.getElementById('deleteCard').style.display = 'block';
            document.getElementById('deleteInfo').textContent =
                `${d.t1} vs ${d.t2} - Winner: ${d.win} (${d.s1}-${d.s2})`;
        }
    }

    function deleteLast() {
        // Admin-only protection
        if (!admin) {
            alert('‚ùå Only admins can delete matches');
            return;
        }

        if (!lastKey) {
            alert('‚ùå No match to delete');
            return;
        }

        if (!confirm('‚ö†Ô∏è Delete last match? This action cannot be undone.')) return;

        db.ref('TriAceDBNEW/' + lastKey).remove().then(() => {
            alert('‚úÖ Match deleted successfully');
            localStorage.removeItem('lastKey');
            localStorage.removeItem('lastData');
            lastKey = null;
            document.getElementById('deleteCard').style.display = 'none';
        }).catch(e => {
            alert('‚ùå Failed to delete: ' + e.message);
        });
    }

    document.getElementById('clearBtn').addEventListener('click', () => {
        scoreText.value = '';
        updatePreview();
    });

    document.getElementById('menuBtn').addEventListener('click', () => {
        document.getElementById('siteNav').classList.toggle('open');
    });
</script>

</body>
</html>
